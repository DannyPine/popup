import type {Placement as PlacementType} from '@floating-ui/core';
import {
  autoUpdate,
  useFloating,
  offset,
  flip,
  shift,
  hide,
  limitShift,
  arrow,
} from '@floating-ui/react-dom';
import {allPlacements} from '../utils/allPlacements';
import {useState} from 'react';
import {Controls} from '../utils/Controls';
import {useSize} from '../utils/useSize';

const arrowEl = document.createElement('div');

export function Perf() {
  const [placement, setPlacement] = useState<PlacementType>('bottom');
  const {x, y, reference, floating, strategy} = useFloating({
    placement: 'top',
    whileElementsMounted: autoUpdate,
    middleware: [
      offset(1),
      flip(),
      shift({crossAxis: true, limiter: limitShift()}),
      hide(),
      arrow({element: arrowEl}),
    ],
  });

  const [size, handleSizeChange] = useSize();

  return (
    <>
      <h1>Perf</h1>
      <p>
        The ref and floating element is nested within 100+ offsetParent
        containers. With 6x CPU slow down on an M1 Mac, `computePosition`
        updates should take less than <strong>15ms</strong>.
      </p>
      <div className="container">
        <div
          style={{
            position: 'relative',
            overflow: 'hidden',
            height: 200,
            background: '#ddd',
          }}
        >
          <div style={{position: 'relative'}}>
            <div style={{position: 'relative'}}>
              <div style={{position: 'relative'}}>
                <div style={{position: 'relative'}}>
                  <div style={{position: 'relative'}}>
                    <div style={{position: 'relative'}}>
                      <div style={{position: 'relative'}}>
                        <div style={{position: 'relative'}}>
                          <div style={{position: 'relative'}}>
                            <div style={{position: 'relative'}}>
                              <div style={{position: 'relative'}}>
                                <div style={{position: 'relative'}}>
                                  <div style={{position: 'relative'}}>
                                    <div style={{position: 'relative'}}>
                                      <div style={{position: 'relative'}}>
                                        <div style={{position: 'relative'}}>
                                          <div style={{position: 'relative'}}>
                                            <div style={{position: 'relative'}}>
                                              <div
                                                style={{position: 'relative'}}
                                              >
                                                <div
                                                  style={{position: 'relative'}}
                                                >
                                                  <div
                                                    style={{
                                                      position: 'relative',
                                                    }}
                                                  >
                                                    <div
                                                      style={{
                                                        position: 'relative',
                                                      }}
                                                    >
                                                      <div
                                                        style={{
                                                          position: 'relative',
                                                        }}
                                                      >
                                                        <div
                                                          style={{
                                                            position:
                                                              'relative',
                                                          }}
                                                        >
                                                          <div
                                                            style={{
                                                              position:
                                                                'relative',
                                                            }}
                                                          >
                                                            <div
                                                              style={{
                                                                position:
                                                                  'relative',
                                                              }}
                                                            >
                                                              <div
                                                                style={{
                                                                  position:
                                                                    'relative',
                                                                }}
                                                              >
                                                                <div
                                                                  style={{
                                                                    position:
                                                                      'relative',
                                                                  }}
                                                                >
                                                                  <div
                                                                    style={{
                                                                      position:
                                                                        'relative',
                                                                    }}
                                                                  >
                                                                    <div
                                                                      style={{
                                                                        position:
                                                                          'relative',
                                                                      }}
                                                                    >
                                                                      <div
                                                                        style={{
                                                                          position:
                                                                            'relative',
                                                                        }}
                                                                      >
                                                                        <div
                                                                          style={{
                                                                            position:
                                                                              'relative',
                                                                          }}
                                                                        >
                                                                          <div
                                                                            style={{
                                                                              position:
                                                                                'relative',
                                                                            }}
                                                                          >
                                                                            <div
                                                                              style={{
                                                                                position:
                                                                                  'relative',
                                                                              }}
                                                                            >
                                                                              <div
                                                                                style={{
                                                                                  position:
                                                                                    'relative',
                                                                                }}
                                                                              >
                                                                                <div
                                                                                  style={{
                                                                                    position:
                                                                                      'relative',
                                                                                  }}
                                                                                >
                                                                                  <div
                                                                                    style={{
                                                                                      position:
                                                                                        'relative',
                                                                                    }}
                                                                                  >
                                                                                    <div
                                                                                      style={{
                                                                                        position:
                                                                                          'relative',
                                                                                      }}
                                                                                    >
                                                                                      <div
                                                                                        style={{
                                                                                          position:
                                                                                            'relative',
                                                                                        }}
                                                                                      >
                                                                                        <div
                                                                                          style={{
                                                                                            position:
                                                                                              'relative',
                                                                                          }}
                                                                                        >
                                                                                          <div
                                                                                            style={{
                                                                                              position:
                                                                                                'relative',
                                                                                            }}
                                                                                          >
                                                                                            <div
                                                                                              style={{
                                                                                                position:
                                                                                                  'relative',
                                                                                              }}
                                                                                            >
                                                                                              <div
                                                                                                style={{
                                                                                                  position:
                                                                                                    'relative',
                                                                                                }}
                                                                                              >
                                                                                                <div
                                                                                                  style={{
                                                                                                    position:
                                                                                                      'relative',
                                                                                                  }}
                                                                                                >
                                                                                                  <div
                                                                                                    style={{
                                                                                                      position:
                                                                                                        'relative',
                                                                                                    }}
                                                                                                  >
                                                                                                    <div
                                                                                                      style={{
                                                                                                        position:
                                                                                                          'relative',
                                                                                                      }}
                                                                                                    >
                                                                                                      <div
                                                                                                        style={{
                                                                                                          position:
                                                                                                            'relative',
                                                                                                        }}
                                                                                                      >
                                                                                                        <div
                                                                                                          style={{
                                                                                                            position:
                                                                                                              'relative',
                                                                                                          }}
                                                                                                        >
                                                                                                          <div
                                                                                                            style={{
                                                                                                              position:
                                                                                                                'relative',
                                                                                                            }}
                                                                                                          >
                                                                                                            <div
                                                                                                              style={{
                                                                                                                position:
                                                                                                                  'relative',
                                                                                                              }}
                                                                                                            >
                                                                                                              <div
                                                                                                                style={{
                                                                                                                  position:
                                                                                                                    'relative',
                                                                                                                }}
                                                                                                              >
                                                                                                                <div
                                                                                                                  style={{
                                                                                                                    position:
                                                                                                                      'relative',
                                                                                                                  }}
                                                                                                                >
                                                                                                                  <div
                                                                                                                    style={{
                                                                                                                      position:
                                                                                                                        'relative',
                                                                                                                    }}
                                                                                                                  >
                                                                                                                    <div
                                                                                                                      style={{
                                                                                                                        position:
                                                                                                                          'relative',
                                                                                                                      }}
                                                                                                                    >
                                                                                                                      <div
                                                                                                                        style={{
                                                                                                                          position:
                                                                                                                            'relative',
                                                                                                                        }}
                                                                                                                      >
                                                                                                                        <div
                                                                                                                          style={{
                                                                                                                            position:
                                                                                                                              'relative',
                                                                                                                          }}
                                                                                                                        >
                                                                                                                          <div
                                                                                                                            style={{
                                                                                                                              position:
                                                                                                                                'relative',
                                                                                                                            }}
                                                                                                                          >
                                                                                                                            <div
                                                                                                                              style={{
                                                                                                                                position:
                                                                                                                                  'relative',
                                                                                                                              }}
                                                                                                                            >
                                                                                                                              <div
                                                                                                                                style={{
                                                                                                                                  position:
                                                                                                                                    'relative',
                                                                                                                                }}
                                                                                                                              >
                                                                                                                                <div
                                                                                                                                  style={{
                                                                                                                                    position:
                                                                                                                                      'relative',
                                                                                                                                  }}
                                                                                                                                >
                                                                                                                                  <div
                                                                                                                                    style={{
                                                                                                                                      position:
                                                                                                                                        'relative',
                                                                                                                                    }}
                                                                                                                                  >
                                                                                                                                    <div
                                                                                                                                      style={{
                                                                                                                                        position:
                                                                                                                                          'relative',
                                                                                                                                      }}
                                                                                                                                    >
                                                                                                                                      <div
                                                                                                                                        style={{
                                                                                                                                          position:
                                                                                                                                            'relative',
                                                                                                                                        }}
                                                                                                                                      >
                                                                                                                                        <div
                                                                                                                                          style={{
                                                                                                                                            position:
                                                                                                                                              'relative',
                                                                                                                                          }}
                                                                                                                                        >
                                                                                                                                          <div
                                                                                                                                            style={{
                                                                                                                                              position:
                                                                                                                                                'relative',
                                                                                                                                            }}
                                                                                                                                          >
                                                                                                                                            <div
                                                                                                                                              style={{
                                                                                                                                                position:
                                                                                                                                                  'relative',
                                                                                                                                              }}
                                                                                                                                            >
                                                                                                                                              <div
                                                                                                                                                style={{
                                                                                                                                                  position:
                                                                                                                                                    'relative',
                                                                                                                                                }}
                                                                                                                                              >
                                                                                                                                                <div
                                                                                                                                                  style={{
                                                                                                                                                    position:
                                                                                                                                                      'relative',
                                                                                                                                                  }}
                                                                                                                                                >
                                                                                                                                                  <div
                                                                                                                                                    style={{
                                                                                                                                                      position:
                                                                                                                                                        'relative',
                                                                                                                                                    }}
                                                                                                                                                  >
                                                                                                                                                    <div
                                                                                                                                                      style={{
                                                                                                                                                        position:
                                                                                                                                                          'relative',
                                                                                                                                                      }}
                                                                                                                                                    >
                                                                                                                                                      <div
                                                                                                                                                        style={{
                                                                                                                                                          position:
                                                                                                                                                            'relative',
                                                                                                                                                        }}
                                                                                                                                                      >
                                                                                                                                                        <div
                                                                                                                                                          style={{
                                                                                                                                                            position:
                                                                                                                                                              'relative',
                                                                                                                                                          }}
                                                                                                                                                        >
                                                                                                                                                          <div
                                                                                                                                                            style={{
                                                                                                                                                              position:
                                                                                                                                                                'relative',
                                                                                                                                                            }}
                                                                                                                                                          >
                                                                                                                                                            <div
                                                                                                                                                              style={{
                                                                                                                                                                position:
                                                                                                                                                                  'relative',
                                                                                                                                                              }}
                                                                                                                                                            >
                                                                                                                                                              <div
                                                                                                                                                                style={{
                                                                                                                                                                  position:
                                                                                                                                                                    'relative',
                                                                                                                                                                }}
                                                                                                                                                              >
                                                                                                                                                                <div
                                                                                                                                                                  style={{
                                                                                                                                                                    position:
                                                                                                                                                                      'relative',
                                                                                                                                                                  }}
                                                                                                                                                                >
                                                                                                                                                                  <div
                                                                                                                                                                    style={{
                                                                                                                                                                      position:
                                                                                                                                                                        'relative',
                                                                                                                                                                    }}
                                                                                                                                                                  >
                                                                                                                                                                    <div
                                                                                                                                                                      style={{
                                                                                                                                                                        position:
                                                                                                                                                                          'relative',
                                                                                                                                                                      }}
                                                                                                                                                                    >
                                                                                                                                                                      <div
                                                                                                                                                                        style={{
                                                                                                                                                                          position:
                                                                                                                                                                            'relative',
                                                                                                                                                                        }}
                                                                                                                                                                      >
                                                                                                                                                                        <div
                                                                                                                                                                          style={{
                                                                                                                                                                            position:
                                                                                                                                                                              'relative',
                                                                                                                                                                          }}
                                                                                                                                                                        >
                                                                                                                                                                          <div
                                                                                                                                                                            style={{
                                                                                                                                                                              position:
                                                                                                                                                                                'relative',
                                                                                                                                                                            }}
                                                                                                                                                                          >
                                                                                                                                                                            <div
                                                                                                                                                                              style={{
                                                                                                                                                                                position:
                                                                                                                                                                                  'relative',
                                                                                                                                                                              }}
                                                                                                                                                                            >
                                                                                                                                                                              <div
                                                                                                                                                                                style={{
                                                                                                                                                                                  position:
                                                                                                                                                                                    'relative',
                                                                                                                                                                                }}
                                                                                                                                                                              >
                                                                                                                                                                                <div
                                                                                                                                                                                  style={{
                                                                                                                                                                                    position:
                                                                                                                                                                                      'relative',
                                                                                                                                                                                  }}
                                                                                                                                                                                >
                                                                                                                                                                                  <div
                                                                                                                                                                                    style={{
                                                                                                                                                                                      position:
                                                                                                                                                                                        'relative',
                                                                                                                                                                                    }}
                                                                                                                                                                                  >
                                                                                                                                                                                    <div
                                                                                                                                                                                      style={{
                                                                                                                                                                                        position:
                                                                                                                                                                                          'relative',
                                                                                                                                                                                      }}
                                                                                                                                                                                    >
                                                                                                                                                                                      <div
                                                                                                                                                                                        style={{
                                                                                                                                                                                          position:
                                                                                                                                                                                            'relative',
                                                                                                                                                                                        }}
                                                                                                                                                                                      >
                                                                                                                                                                                        <div
                                                                                                                                                                                          style={{
                                                                                                                                                                                            position:
                                                                                                                                                                                              'relative',
                                                                                                                                                                                          }}
                                                                                                                                                                                        >
                                                                                                                                                                                          <div
                                                                                                                                                                                            style={{
                                                                                                                                                                                              position:
                                                                                                                                                                                                'relative',
                                                                                                                                                                                            }}
                                                                                                                                                                                          >
                                                                                                                                                                                            <div
                                                                                                                                                                                              style={{
                                                                                                                                                                                                position:
                                                                                                                                                                                                  'relative',
                                                                                                                                                                                              }}
                                                                                                                                                                                            >
                                                                                                                                                                                              <div
                                                                                                                                                                                                style={{
                                                                                                                                                                                                  position:
                                                                                                                                                                                                    'relative',
                                                                                                                                                                                                }}
                                                                                                                                                                                              >
                                                                                                                                                                                                <div
                                                                                                                                                                                                  style={{
                                                                                                                                                                                                    position:
                                                                                                                                                                                                      'relative',
                                                                                                                                                                                                  }}
                                                                                                                                                                                                >
                                                                                                                                                                                                  <div
                                                                                                                                                                                                    style={{
                                                                                                                                                                                                      position:
                                                                                                                                                                                                        'relative',
                                                                                                                                                                                                    }}
                                                                                                                                                                                                  >
                                                                                                                                                                                                    <div
                                                                                                                                                                                                      style={{
                                                                                                                                                                                                        position:
                                                                                                                                                                                                          'relative',
                                                                                                                                                                                                      }}
                                                                                                                                                                                                    >
                                                                                                                                                                                                      <div
                                                                                                                                                                                                        style={{
                                                                                                                                                                                                          position:
                                                                                                                                                                                                            'relative',
                                                                                                                                                                                                        }}
                                                                                                                                                                                                      >
                                                                                                                                                                                                        <div
                                                                                                                                                                                                          style={{
                                                                                                                                                                                                            position:
                                                                                                                                                                                                              'relative',
                                                                                                                                                                                                          }}
                                                                                                                                                                                                        >
                                                                                                                                                                                                          <div
                                                                                                                                                                                                            style={{
                                                                                                                                                                                                              position:
                                                                                                                                                                                                                'relative',
                                                                                                                                                                                                            }}
                                                                                                                                                                                                          >
                                                                                                                                                                                                            <div
                                                                                                                                                                                                              style={{
                                                                                                                                                                                                                position:
                                                                                                                                                                                                                  'relative',
                                                                                                                                                                                                              }}
                                                                                                                                                                                                            >
                                                                                                                                                                                                              <div
                                                                                                                                                                                                                style={{
                                                                                                                                                                                                                  position:
                                                                                                                                                                                                                    'relative',
                                                                                                                                                                                                                }}
                                                                                                                                                                                                              >
                                                                                                                                                                                                                <div
                                                                                                                                                                                                                  style={{
                                                                                                                                                                                                                    position:
                                                                                                                                                                                                                      'relative',
                                                                                                                                                                                                                  }}
                                                                                                                                                                                                                >
                                                                                                                                                                                                                  <div
                                                                                                                                                                                                                    style={{
                                                                                                                                                                                                                      position:
                                                                                                                                                                                                                        'relative',
                                                                                                                                                                                                                    }}
                                                                                                                                                                                                                  >
                                                                                                                                                                                                                    <div
                                                                                                                                                                                                                      style={{
                                                                                                                                                                                                                        position:
                                                                                                                                                                                                                          'relative',
                                                                                                                                                                                                                      }}
                                                                                                                                                                                                                    >
                                                                                                                                                                                                                      <div
                                                                                                                                                                                                                        style={{
                                                                                                                                                                                                                          position:
                                                                                                                                                                                                                            'relative',
                                                                                                                                                                                                                        }}
                                                                                                                                                                                                                      >
                                                                                                                                                                                                                        <div
                                                                                                                                                                                                                          style={{
                                                                                                                                                                                                                            position:
                                                                                                                                                                                                                              'relative',
                                                                                                                                                                                                                          }}
                                                                                                                                                                                                                        >
                                                                                                                                                                                                                          <div
                                                                                                                                                                                                                            style={{
                                                                                                                                                                                                                              position:
                                                                                                                                                                                                                                'relative',
                                                                                                                                                                                                                            }}
                                                                                                                                                                                                                          >
                                                                                                                                                                                                                            <div
                                                                                                                                                                                                                              style={{
                                                                                                                                                                                                                                position:
                                                                                                                                                                                                                                  'relative',
                                                                                                                                                                                                                              }}
                                                                                                                                                                                                                            >
                                                                                                                                                                                                                              <div
                                                                                                                                                                                                                                style={{
                                                                                                                                                                                                                                  position:
                                                                                                                                                                                                                                    'relative',
                                                                                                                                                                                                                                }}
                                                                                                                                                                                                                              >
                                                                                                                                                                                                                                <div
                                                                                                                                                                                                                                  style={{
                                                                                                                                                                                                                                    position:
                                                                                                                                                                                                                                      'relative',
                                                                                                                                                                                                                                  }}
                                                                                                                                                                                                                                >
                                                                                                                                                                                                                                  <div
                                                                                                                                                                                                                                    style={{
                                                                                                                                                                                                                                      position:
                                                                                                                                                                                                                                        'relative',
                                                                                                                                                                                                                                    }}
                                                                                                                                                                                                                                  >
                                                                                                                                                                                                                                    <div
                                                                                                                                                                                                                                      ref={
                                                                                                                                                                                                                                        reference
                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                      className="reference"
                                                                                                                                                                                                                                    >
                                                                                                                                                                                                                                      Reference
                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                    <div
                                                                                                                                                                                                                                      ref={
                                                                                                                                                                                                                                        floating
                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                      className="floating"
                                                                                                                                                                                                                                      style={{
                                                                                                                                                                                                                                        position:
                                                                                                                                                                                                                                          strategy,
                                                                                                                                                                                                                                        top:
                                                                                                                                                                                                                                          y ??
                                                                                                                                                                                                                                          '',
                                                                                                                                                                                                                                        left:
                                                                                                                                                                                                                                          x ??
                                                                                                                                                                                                                                          '',
                                                                                                                                                                                                                                        width:
                                                                                                                                                                                                                                          size,
                                                                                                                                                                                                                                        height:
                                                                                                                                                                                                                                          size,
                                                                                                                                                                                                                                        // ...styles.popper,
                                                                                                                                                                                                                                      }}
                                                                                                                                                                                                                                    >
                                                                                                                                                                                                                                      Floating
                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                  </div>
                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                          </div>
                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                  </div>
                                                                                                                                                                                                                </div>
                                                                                                                                                                                                              </div>
                                                                                                                                                                                                            </div>
                                                                                                                                                                                                          </div>
                                                                                                                                                                                                        </div>
                                                                                                                                                                                                      </div>
                                                                                                                                                                                                    </div>
                                                                                                                                                                                                  </div>
                                                                                                                                                                                                </div>
                                                                                                                                                                                              </div>
                                                                                                                                                                                            </div>
                                                                                                                                                                                          </div>
                                                                                                                                                                                        </div>
                                                                                                                                                                                      </div>
                                                                                                                                                                                    </div>
                                                                                                                                                                                  </div>
                                                                                                                                                                                </div>
                                                                                                                                                                              </div>
                                                                                                                                                                            </div>
                                                                                                                                                                          </div>
                                                                                                                                                                        </div>
                                                                                                                                                                      </div>
                                                                                                                                                                    </div>
                                                                                                                                                                  </div>
                                                                                                                                                                </div>
                                                                                                                                                              </div>
                                                                                                                                                            </div>
                                                                                                                                                          </div>
                                                                                                                                                        </div>
                                                                                                                                                      </div>
                                                                                                                                                    </div>
                                                                                                                                                  </div>
                                                                                                                                                </div>
                                                                                                                                              </div>
                                                                                                                                            </div>
                                                                                                                                          </div>
                                                                                                                                        </div>
                                                                                                                                      </div>
                                                                                                                                    </div>
                                                                                                                                  </div>
                                                                                                                                </div>
                                                                                                                              </div>
                                                                                                                            </div>
                                                                                                                          </div>
                                                                                                                        </div>
                                                                                                                      </div>
                                                                                                                    </div>
                                                                                                                  </div>
                                                                                                                </div>
                                                                                                              </div>
                                                                                                            </div>
                                                                                                          </div>
                                                                                                        </div>
                                                                                                      </div>
                                                                                                    </div>
                                                                                                  </div>
                                                                                                </div>
                                                                                              </div>
                                                                                            </div>
                                                                                          </div>
                                                                                        </div>
                                                                                      </div>
                                                                                    </div>
                                                                                  </div>
                                                                                </div>
                                                                              </div>
                                                                            </div>
                                                                          </div>
                                                                        </div>
                                                                      </div>
                                                                    </div>
                                                                  </div>
                                                                </div>
                                                              </div>
                                                            </div>
                                                          </div>
                                                        </div>
                                                      </div>
                                                    </div>
                                                  </div>
                                                </div>
                                              </div>
                                            </div>
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <Controls>
        <label htmlFor="size">Size</label>
        <input
          id="size"
          type="range"
          min="1"
          max="200"
          value={size}
          onChange={handleSizeChange}
        />
      </Controls>

      <Controls>
        {allPlacements.map((localPlacement) => (
          <button
            key={localPlacement}
            data-testid={`placement-${localPlacement}`}
            onClick={() => setPlacement(localPlacement)}
            style={{
              backgroundColor: localPlacement === placement ? 'black' : '',
            }}
          >
            {localPlacement}
          </button>
        ))}
      </Controls>
    </>
  );
}
